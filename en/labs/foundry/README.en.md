# Azure AI Foundry — Multi-Agent Workshop

## Introduction

This section of the workshop covers the **reasoning and execution layer** of Contoso Retail’s multi-agent architecture, implemented on **Azure AI Foundry**. This is where intelligent agents are built, they interpret data and plan actions to be executed, based on the information generated by the data layer (Microsoft Fabric).

### Agents for this layer

| Agent | Role | Description |
|--------|-----|-------------|
| **Anders** | Executor Agent | Receives operational action requests (such as report generation or invoice rendering) and executes them by interacting with external services such as the Azure Function `FxContosoRetail`. Type: `kind: "prompt"` with OpenAPI tool. |
| **Julie** | Planner Agent (Workflow) | Orchestrates personalized marketing campaigns. Receives a customer segment description and executes a 5-step flow: (1) extracts the customer filter, (2) invokes **SqlAgent** to generate T-SQL, (3) executes the query against Fabric via **Function App OpenAPI**, (4) invokes **MarketingAgent** (with Bing Search) to generate per-customer messages, (5) organizes the result as campaign email JSON. Type: `kind: "workflow"` with 3 tools (2 agents + 1 OpenAPI). |

### General architecture

The Foundry layer is located at the center of the three-layer architecture:

```
┌─────────────────────┐
│   Copilot Studio    │  ← Interaction layer (Charles, Bill, Ric)
├─────────────────────┤
│  Azure AI Foundry   │  ← Reasoning layer (Anders, Julie) ★
├─────────────────────┤
│  Microsoft Fabric   │  ← Data layer (Mark)
└─────────────────────┘
```

Anders and Julie agents use GPT-4.1 models deployed in Azure AI Services to reason over business information. Anders directly consumes the `FxContosoRetail` API via an OpenAPI tool. Julie orchestrates a multi-agent workflow: it uses **SqlAgent** (generates T-SQL), a **Function App** (executes SQL against Fabric via OpenAPI), and **MarketingAgent** (generates personalized messages with Bing Search), coordinating everything autonomously as a `workflow`-type agent.

---

## Labs

| Lab | File | Description |
|-----|---------|-------------|
| Lab 4 | [Anders — Executor Agent](lab04-anders-executor-agent.en.md) | Create the executor agent that generates reports and interacts with Contoso Retail services. |
| Lab 5 | [Julie — Planner Agent](lab05-julie-planner-agent.en.md) | Create the marketing campaign orchestrator agent using the workflow pattern with sub-agents (SqlAgent, MarketingAgent) and an OpenAPI tool. |

---

## Infrastructure setup

Before starting the labs, each participant must deploy the Azure infrastructure in their own subscription. The process is automated with Bicep and a PowerShell script.

The project offers **two deployment options** located in sibling folders under `setup/`. Both deploy the same logical resources and publish the same C# code for `FxContosoRetail`, but differ in the hosting plan and security model.

| | Flex Consumption Option ⭐ | Classic Consumption Option |
|---|---|---|
| **Folder** | `setup/op-flex` | `setup/op-consumption` |
| **Plan SKU** | FC1 / FlexConsumption | Y1 / Dynamic (Consumption) |
| **OS** | Linux | Windows |
| **Storage authentication** | Managed Identity (no secrets) | Connection string (SharedKey) |
| **File Share** | Not required | Requires pre-created file share |
| **Security** | `allowSharedKeyAccess: false` | `allowSharedKeyAccess: true` |

> **Recommendation:** Use the **Flex Consumption** option (`op-flex`). It is a more modern and secure model: it does not store secrets in app settings, uses Managed Identity for Storage authentication, and does not require file shares.

### Prerequisites

- **Azure CLI** installed and up to date ([install](https://aka.ms/installazurecli))
- **.NET 8 SDK** installed ([download](https://dotnet.microsoft.com/download/dotnet/8.0))
- **PowerShell** 5.1 or later (Windows) or PowerShell Core 7+ (macOS/Linux)
- An active **Azure subscription** with Owner or Contributor permissions
- The assigned **temporary tenant name**
- (Optional) Fabric Warehouse values:
   - `FabricWarehouseSqlEndpoint`
   - `FabricWarehouseDatabase`

### How to obtain Fabric parameters?

These values are obtained from the **Fabric environment deployed in Lab 1** (`../fabric/lab01-data-setup.en.md`).

In your Fabric Workspace, open the **Warehouse** and copy the SQL **connection string**. You will see something like:

```text
Data Source=xxxxx.database.fabric.microsoft.com,1433;Initial Catalog=retail_sqldatabase_xxx;...
```

Mapping:

- `FabricWarehouseSqlEndpoint` = `Data Source` without `,1433`
- `FabricWarehouseDatabase` = `Initial Catalog`

Example:

- `FabricWarehouseSqlEndpoint`: `kqbvkknqlijebcyrtw2rgtsx2e-dvthxhg2tsuurev2kck26gww4q.database.fabric.microsoft.com`
- `FabricWarehouseDatabase`: `retail_sqldatabase_danrdol6ases3c-6d18d61e-43a5-4281-a754-b255fc9a6c9b`

If you are not following the full lab sequence, only a SQL database is used here for Lab 5 (Julie) queries. You can point directly to a standalone SQL database (for example Azure SQL Database) using:

- `FabricWarehouseSqlEndpoint` = SQL host of your standalone database
- `FabricWarehouseDatabase` = name of your database

If you do not provide these values, the deployment does not fail: it skips the DB configuration for Lab 5 and shows a warning to configure it manually later.

### Sign in to Azure

Before running any deployment script, you must authenticate to Azure from the terminal.

1. **Open a terminal in VS Code:** use the **Terminal → New Terminal** menu or the shortcut <kbd>Ctrl</kbd>+<kbd>`</kbd>.

2. **Sign in with Azure CLI:**

   ```powershell
   az login
   ```

   This will open the browser for you to authenticate with your Azure account. Once completed, the terminal will show the list of available subscriptions.

3. **Verify the active subscription:**

   ```powershell
   az account show --output table
   ```

   Confirm that the displayed subscription is the correct one for the workshop. If you need to change it:

   ```powershell
   az account set --subscription "subscription-name-or-id"
   ```

> **Note:** The deployment script also automatically checks whether there is an active session and, if not, triggers `az login`. However, it is recommended to ensure you are authenticated before running it to avoid interruptions.

### Resources that are created

Both options provision the following resources within the Resource Group `rg-contoso-retail`:

| Resource | Name | Description |
|---------|--------|-------------|
| Storage Account | `stcontosoretail{suffix}` | Storage for the Function App |
| App Service Plan | `asp-contosoretail-{suffix}` | Hosting plan (FC1 in Flex, Y1 in Consumption) |
| Function App | `func-contosoretail-{suffix}` | Contoso Retail API (.NET 8, dotnet-isolated) |
| AI Foundry Resource | `ais-contosoretail-{suffix}` | Unified AI Foundry resource (AI Services + project management) with GPT-4.1 model deployed |
| AI Foundry Project | `aip-contosoretail-{suffix}` | Working project within the Foundry Resource |
| Blob Container | `reports` | Container for generated reports |

> **Note:** The `{suffix}` is a unique 5-character identifier automatically generated from your tenant name. This ensures resource names do not collide between participants.

---

### Deployment script parameters

Both scripts (`op-flex/deploy.ps1` and `op-consumption/deploy.ps1`) accept the same parameters:

| Parameter | Required | Default | Description |
|-----------|:-----------:|---------|-------------|
| `-TenantName` | **Yes** | — | Name of the temporary tenant assigned to the participant. Used to generate a unique 5-character suffix. |
| `-Location` | No | `eastus` | Azure region where resources are deployed. |
| `-ResourceGroupName` | No | `rg-contoso-retail` | Name of the Resource Group. |
| `-FabricWarehouseSqlEndpoint` | No | *(empty)* | SQL endpoint of the Fabric Warehouse (no protocol, no port). Example: `xyz.datawarehouse.fabric.microsoft.com` |
| `-FabricWarehouseDatabase` | No | *(empty)* | Name of the Fabric Warehouse database. |

#### Interactive behavior

If you run the script with only `-TenantName`:

```powershell
.\deploy.ps1 -TenantName "your-temporary-tenant"
```

The script will prompt you interactively for the optional parameters. Press **Enter** to accept the default value shown in brackets:

```
Press Enter for default.
Location [eastus]:                           ← Enter to accept eastus
ResourceGroupName [rg-contoso-retail]:       ← Enter to accept rg-contoso-retail
Do you want to configure the Fabric SQL connection for Lab05 now? (y/N):  ← N to skip
```

If you answer **y** to the Fabric question, it will prompt you for:

```
FabricWarehouseSqlEndpoint (no protocol, no port): kqbvkk...fabric.microsoft.com
FabricWarehouseDatabase: retail_sqldatabase_xxx
```

If you provide only one of the two Fabric parameters, the script will prompt for the missing one.

#### Silent execution (no prompts)

If you pass all parameters via the command line, the script will not prompt for anything:

```powershell
.\deploy.ps1 `
  -TenantName "your-temporary-tenant" `
  -Location "eastus" `
  -ResourceGroupName "rg-contoso-retail" `
  -FabricWarehouseSqlEndpoint "xyz.datawarehouse.fabric.microsoft.com" `
  -FabricWarehouseDatabase "retail_sqldatabase_xxx"
```

> **Note:** If you do not provide the Fabric parameters, the deployment **does not fail**. It skips configuring the SQL connection and shows a warning to configure it manually later. The SQL connection is only needed for Lab 5 (Julie) and the `SqlExecutor` Function App.

---

### Option 1 (Recommended): Flex Consumption (`op-flex`)

Modern Linux-based model with Managed Identity authentication. The Storage Account does not expose shared keys and the Function App authenticates using blob/queue/table URIs with managed identity credentials. RBAC permissions are automatically assigned via `storage-rbac.bicep`.

> **Note:** The Flex Consumption SCM endpoint may take time to become available (DNS resolution). The deployment script includes retry logic and automatic wait.

1. **Open a PowerShell terminal** at the root of the repository.

2. **Navigate to the Flex Consumption folder:**

   ```powershell
   cd labs\foundry\setup\op-flex
   ```

3. **Run the deployment script** with your tenant name (and optionally the Fabric parameters):

   ```powershell
  ric>" `
     -FabricWarehouseDatabase "<database-warehouse>"
   ```

    You can also run just:

    ```powershell
    .\deploy.ps1 -TenantName "your-temporary-tenant"
    ```

4. **Review the output.** When finished, the script displays the names and URLs of all created resources. Take note of these values, as you will need them in the labs.

---

### Option 2: Classic Consumption (`op-consumption`)

Classic Windows-based model with connection string authentication. Requires a pre-created Azure Files share (included in the Bicep) to avoid race conditions. App settings include `WEBSITE_CONTENTAZUREFILECONNECTIONSTRING` and `WEBSITE_CONTENTSHARE`.

1. **Open a PowerShell terminal** at the root of the repository.

2. **Navigate to the Consumption folder:**

   ```powershell
   cd labs\foundry\setup\op-consumption
   ```

3. **Run the deployment script** with your tenant name (and optionally the Fabric parameters):

   ```powershell
   .\deploy.ps1 `
     -TenantName "your-temporary-tenant" `
     -FabricWarehouseSqlEndpoint "<endpoint-sql-fabric>" `
     -FabricWarehouseDatabase "<database-warehouse>"
   ```

    You can also run just:

    ```powershell
    .\deploy.ps1 -TenantName "your-temporary-tenant"
    ```

4. **Review the output.** When finished, the script displays the names and URLs of all created resources.

---

### Verification

After deployment, verify that the resources were created correctly:

```powershell
az resource list --resource-group rg-contoso-retail --output table
```

---

### RBAC permissions for Azure AI Foundry

For agents to be created and executed in Azure AI Foundry, your user needs the **Cognitive Services User** role on the AI Services resource. This role includes the data action `Microsoft.CognitiveServices/*` required for agent operations. If you do not have it, you will get a `PermissionDenied` error when attempting to create agents.

Run the following commands to assign the role (replace `{suffix}` with your 5-character suffix):

```powershell
# Get your user name (UPN)
$upn = az account show --query "user.name" -o tsv

# Assign the Cognitive Services User role on the AI Services resource
az role assignment create `
    --assignee $upn `
    --role "Cognitive Services User" `
    --scope "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/rg-contoso-retail/providers/Microsoft.CognitiveServices/accounts/ais-contosoretail-{suffix}"
```

> **Note:** If you do not know the exact resource name, you can find it with:
> ```powershell
> az cognitiveservices account list --resource-group rg-contoso-retail --query "[].name" -o tsv
> ```
>
>RBAC propagation may take up to 1 minute. Wait before attempting to create agents.

---

## Code structure

```
labs/foundry/
├── README.md                              ← Este archivo
├── lab04-anders-executor-agent.md          ← Lab 4: Agente Anders
├── lab05-julie-planner-agent.md           ← Lab 5: Agente Julie
├── setup/
│   ├── op-flex/                           ← ⭐ Opción recomendada (Flex Consumption / Linux)
│   │   ├── main.bicep
│   │   ├── storage-rbac.bicep
│   │   └── deploy.ps1
│   └── op-consumption/                    ← Opción clásica (Consumption Y1 / Windows)
│       ├── main.bicep
│       ├── storage-rbac.bicep
│       └── deploy.ps1
└── code/
    ├── api/
    │   └── FxContosoRetail/               ← Azure Function (API)
    │       ├── FxContosoRetail.cs          ← Endpoints: HolaMundo, OrdersReporter, SqlExecutor
    │       ├── Program.cs
    │       ├── Models/
    │       └── ...
    ├── agents/
    │   ├── AndersAgent/                   ← Console App: Agente Anders (kind: prompt + OpenAPI tool)
    │   │   ├── ms-foundry/                ← Versión Responses API (recomendada)
    │   │   │   ├── Program.cs
    │   │   │   └── appsettings.json
    │   │   └── ai-foundry/                ← Versión Persistent Agents API (alternativa)
    │   │       └── ...
    │   └── JulieAgent/                    ← Console App: Agente Julie (kind: workflow)
    │       ├── Program.cs                 ← Crea los 3 agentes + chat con Julie
    │       ├── JulieAgent.cs              ← Julie: workflow con 3 tools (SqlAgent, MarketingAgent, OpenAPI)
    │       ├── SqlAgent.cs                ← Sub-agente: genera T-SQL a partir de lenguaje natural
    │       ├── MarketingAgent.cs           ← Sub-agente: genera mensajes con Bing Search
    │       ├── db-structure.txt            ← DDL de la BD inyectada en SqlAgent
    │       └── appsettings.json
    └── tests/
        ├── bruno/                         ← Colección Bruno (REST client)
        │   ├── bruno.json
        │   ├── OrdersReporter.bru
        │   └── environments/
        │       └── local.bru
        └── http/
            └── FxContosoRetail.http       ← Archivo .http (VS Code REST Client)
```

---

## Next step

Once the setup is complete, continue with [Lab 4 — Anders (Executor Agent)](lab04-anders-executor-agent.en.md).
``